### Homework 3
#### Задание 1
Использовал traceroute с ключом -I под Linux, что соответствует использованию ICMP echo request. Использовал виртуальную машину с Ubuntu Server 20.04 и VPS с Ubuntu 18.04.  Основные выводы:
1. Из-за использования load balancer'ов путь пакета невозможно предсказать, поэтому количество хопов может варьироваться от запуска к запуску. traceroute по умолчанию отправляет три запроса, зачастую в одной строке ответа попадаются разные адреса отвечающих хостов.
2. Через слэш приведены неотвечающие хопы. В первом случае как минимум два скрываются моим провайдером (после попадания в сеть Golden Telecom почти все отвечают), в последнем случае часть хопов скрывает облачный хостинг Vultr.
3. Многие промежуточные хопы на ICMP не отвечают. Особенно много таковых в сети Amazon.

Site |  Hops from WSL | Hops from Vultr
-----|---------------|-----------------
cisco.com |18/4 | 15/6
yandex.ru | 10/3 | 7/4
microsoft.com (только промежуточные) | 23/3 |9/3
google.com | 13/2 | 14/5|
aws.amazon.com |19/7 | 15/9
habr.com | 11/2 | 8/4
stackoverflow.com |19/7| 15/9



#### Задание 2: OS guessing
Первая мысль - смотреть на TTL при ответе на ping. Примерно представляя себе количество хопов можно догадаться о TTL отправленного пакета. Например, от cisco.com приходят пакеты с TTL 237. traceroute показал длину пути в 18 хопов, то есть у исходного пакета был TTL 255, что соответствует OS Cisco IOS. 
Но от google.com 114 + 13 = 127 => Windows, что маловероятно. Не самая лучшая мысль, поскольку с помощью traceroute можно узнать длину пути только от нас к удаленному хосту, но не обратно, и TTL отправляемых пакетов может вручную задаваться отличным от дефолтного.

Попытка вторая - nmap с ключом -O. Очень часто попадается ответ *"OSScan results may be unreliable because we could not find at least 1 open and 1 closed port"*. OS в выводе чаще всего *Just Guessing*, почти у всех несколько вариантов (Linux, FreeBSD, OpenBSD) с вероятностями 86-87% и результаты отличаются от запроса к запросу. Вероятно, роль играет использование балансировщиков нагрузки, у cisco.com это всегда Citrix Load Balancer. У aws.amazon.com показывается Amazon Cloudfront - CDN. У habr.com - Qrator - Firewall.

Несколько лучших результатов можно добиться анализом вывода nmap -A. В этом случае можно смотреть чем управляется открытый порт (у всех это 80/tcp и 443/tcp). Чаще всего встречается x86_64-pc-linux-gnu, что вполне соответствует действительности. Можно вручную сделать HTTP запрос и посмотреть на сервер в заголовке ответа. 
У microsoft.com это Kestrel, работающий под Linux и Windows Server, но Microsoft давно перевели свои сервера на Linux.
У google.com это gws, в Википедии сказано, что он работает под Heavy Modified Debian Linux.
Вероятно, последний подход может предоставить хоть некоторую точность. Я проверил заведомо использующий IIS американский Красный Крест redcross.org. nmap -A подтверждает IIS на 80 и 443 портах, но Windows Server 2012 выдает даже не первой в списке.

#### Задание 3: Определение узких мест
Под узкими местами можно понимать хосты, на которых происходит потеря пакетов или заметно возрастает время ответа.
Изначально отправлял по 200 пакетов с помощью mtr, но неправильно выводил результаты в файл, получилось нечитаемо. Нижеприведенные результаты основаны на 100 пакетах. Поскольку всегда были неотвечающие хосты (см. первое задание), потеря пакетов на них составляет 100% и не учитывается. Иногда наблюдались незначительная потеря пакетов и рост пинга у моего провайдера (беспроводной Beeline).

1. https://cisco.com - заметная потеря пакетов (57%!) и двухкратный рост пинга в точке обмена трафиком Amsterdam Level 3. Далее еще двухкратный рост времени ответа после попадания в сеть Cisco.
2. https://yandex.ru - некоторая потеря пакетов (4%) в сети Яндекса, незначительный рост пинга при переходе от магистрального провайдера Golden Telecom в сеть Яндекса.
3. https://microsoft.com (только промежуточные) - значительный (шести- семикратный) рост пинга в сети Microsoft. 
4. https://google.com  - узких мест не выявлено, кроме незначительного роста пинга в сети google.
5. https://aws.amazon.com - пятикратный рост пинга и потеря пакетов в точке обмена трафиком в Стокгольме.
6. https://habr.com - узких мест не выявлено
7. https://stackoverflow.com - потеря пакетов (47%) и рост пинга в точке обмена трафиком в Стокгольме.

####Задание 4: сравнение разных протоколов работы traceroute
##### cisco.com
* traceroute без параметров и с параметром -U - UDP трафик ходит по множеству путей и теряется в сети Cisco
* traceroute -T - TCP трафик достигает конечного хоста 72.163.4.185 за те же 18 хопов, что у ICMP запроса, перемещается по тому же пути.
##### microsoft.com
* traceroute без параметров и с параметром -U - UDP трафик ходит по множеству путей и теряется в сети Microsoft
* traceroute -T - TCP трафик достигает самых разных конечных хостов, также перемещаясь по разным путям
##### yandex.ru 
* traceroute без параметров - UDP трафик по случайному порту при последовательных запусках одним и тем же путем достигает конечного хоста 5.255.255.88 за те же 10 хопов, что и ICMP echo
* traceroute -U - UDP трафик по 53 порту блокируется магистральным провайдером Golden Telecom
* traceroute -T - TCP SYN при каждом запуске ходит разными путями, достигая различных конечных хостов в сети яндекса. При вызове для конкретного IP адреса хост достигается 10 хопом, но потом переадресовывается куда-то дальше и через несколько скрытых хопов попадает обратно.
>sudo traceroute -T 5.255.255.88
...
>11  yandex.ru (5.255.255.88)  57.862 ms  57.627 ms  58.162 ms
12  * * *
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  yandex.ru (5.255.255.88)  35.706 ms  50.555 ms  50.637 ms

##### habr.com
* traceroute без параметров  и с параметром -U - UDP трафик блокируется магистральным провайдером RetnNet
* traceroute -T - TCP SYN при каждом запуске ходит разными путями, достигая конечного хоста за те же 11 хопов, что и ICMP echo

##### google.com
* traceroute без параметров - UDP трафик по случайному порту при каждом запуске ходит разными путями, достигая различных конечных хостов в сети Google. Результат в целом соответствует использованию ICMP (13-14 хопов)
* traceroute -U - UDP трафик по 53 порту блокируется магистральным провайдером Golden Telecom
* traceroute -T - TCP SYN при каждом запуске ходит разными путями, достигая различных конечных хостов в сети Google. Результат в целом соответствует использованию ICMP (13-14 хопов)

##### aws.amazon.com
* traceroute без параметров - UDP трафик по случайному порту при каждом запуске ходит разными путями, достигая одного и тоже конечного хоста 54.230.97.70. Результат соответствует использованию ICMP (19 хопов). Количество скрытых хопов в сети Amazon то же.
* traceroute -U - UDP трафик по 53 порту теряется в сети Amazon.
* traceroute -T - TCP SYN при каждом запуске ходит разными путями, достигая одного и тоже конечного хоста 54.230.97.70. Результат соответствует использованию ICMP (19 хопов). Количество скрытых хопов в сети Amazon то же.

##### stackoverflow.com
* traceroute без параметров  и с параметром -U - UDP трафик блокируется магистральным провайдером Golden Telecom в точке обмена трафиком в Стокгольме
* traceroute -T - TCP SYN при каждом запуске ходит одним и тем же путем, достигая конечного хоста 151.101.65.65 за те же 9 хопов, что и ICMP echo, но отличным от него маршрутом.

#### Общие выводы
Крупные сервисы типа Amazon и Google имеют крайне обширные сети со сложной балансировкой нагрузки.
Microsoft фильтрует ICMP где-то внутри своей сети.
Microsoft и Cisco фильтруют UDP трафик в своих сетях.
Некоторые магистральные провайдеры фильтруют UDP трафик.